var quickReplyIsVisible = !1, infoConnection, chatConnection, accessToken; const updateInterval = 1e3, tokenInterval = 2e4; infoConnection = (new signalR.HubConnectionBuilder).withUrl("/info").build(); const updateInfo = () => infoConnection.invoke("MainUpdate", appealId), onReceiveInfo = (n, t, i, r) => { if (r) { blockChat(); $("#alarm").hide(); return } if (i) { const n ="До окончания онлайн-чата осталось "+remainingText;$("#alarm").text(n).show()}setTimeout(updateInfo,updateInterval)},toggleQuickReply=n=>{quickReplyIsVisible=n,n?($("#quickReplyButton img").attr("src","images/chat/down-chevron.svg"),$("#quickReply").fadeIn("fast"),$("#quickReply .quick-reply").slideDown("fast",()=>$("#filterText").focus().trigger("input"))):($("#quickReplyButton img").attr("src","images/chat/quick-reply.svg"),$("#quickReply").fadeOut("fast"),$("#quickReply .quick-reply").slideUp("fast",()=>$("#filterText").val("")))},changeStatus=n=>$("#onlineStatus").toggleClass("online",n),sendMessage=n=>{chatConnection.send("SendMessage",n),$("#messageText").val("").trigger("input")},onReceiveMessage=n=>{const i=n.nickName==="Член КК № "+expertKey,t=receiveMessage(n,i);$("#messagesList").append(t).scrollTo(t)},onJoinUser=(n,t)=>{const r=t==="Член КК № "+expertKey,i=joinMessage(n,t,r);$("#messagesList").append(i).scrollTo(i)},onLeaveUser=(n,t)=>{const r=t==="Член КК № "+expertKey,i=leaveMessage(n,t,r);$("#messagesList").append(i).scrollTo(i)},onFirstJoinExpert=n=>{const t=firstJoinMessage(n,!0);$("#messagesList").append(t).scrollTo(t)},onInitializeChange=n=>{blockChat();const t=changeExpertMessage(n);$("#messagesList").append(t).scrollTo(t)},onCompleteChat=()=>{blockChat();const n=completeChatMessage(!0);$("#messagesList").append(n).scrollTo(n)},blockChat=()=>{$("#messageForm, #quickReply").remove()},insertQuickReply=n=>{toggleQuickReply(!1),$("#messageText").insertAtCursor(n).focus().trigger("input")},onFilterTextKeyup=n=>{const t=$("#replyList .selected");switch(n.keyCode){case 13:insertQuickReply(t.text());return;case 38:const n=t.prevAll(":visible").first();if(n.length===0)return;t.removeClass("selected");n.addClass("selected");return;case 40:const i=t.nextAll(":visible").first();if(i.length===0)return;t.removeClass("selected");i.addClass("selected");return}},onFilterTextInput=n=>{const t=$(n.target).val();$("#replyList li").removeClass("selected").hide().filter(":icontains('"+t+"')").show().each((n,i)=>$(i).highlightText(t)).first().addClass("selected")},onMessageTextKeyup=n=>{if(n.keyCode===13&&!n.shiftKey){n.preventDefault();const t=$(n.target).val();t.length>0&&sendMessage(t)}},onMessageTextInput=function(){$(this).expandRows();const n=$(this).val().length===0;$("#sendButton").prop("disabled",n)},refreshToken=(n,t)=>getJwtToken(n,t).then(t=>{accessToken=t,setTimeout(()=>refreshToken(n),tokenInterval)});infoConnection.on("ReceiveInfo",onReceiveInfo);$(window).on("beforeunload unload",()=>sendDisconnectRequest(appealId,expertKey));$(document).ready(()=>{$("#quickReplyButton").on("click",()=>toggleQuickReply(!quickReplyIsVisible));$("#filterText").on("keyup",onFilterTextKeyup).on("input",onFilterTextInput);$("#replyList li").on("click",n=>insertQuickReply($(n.target).text()));$("#messageText").on("keyup",onMessageTextKeyup).on("input",onMessageTextInput).trigger("input");$("#sendButton").on("click",()=>sendMessage($("#messageText").val()))});infoConnection.start().then(updateInfo);refreshToken(appealId,expertKey).then(()=>{const n={accessTokenFactory:()=>accessToken};chatConnection=(new signalR.HubConnectionBuilder).withUrl("chat",n).configureLogging(signalR.LogLevel.Trace).build();chatConnection.on("Receive",onReceiveMessage);chatConnection.on("Join",onJoinUser);chatConnection.on("Leave",onLeaveUser);chatConnection.on("FirstJoinExpert",onFirstJoinExpert);chatConnection.on("InitializeChange",onInitializeChange);chatConnection.on("CompleteChat",onCompleteChat);chatConnection.on("OnlineStatus",changeStatus);return chatConnection.start()}).then(()=>setTimeout(()=>refreshToken(appealId),tokenInterval)).catch(n=>{console.error(n.toString()),blockChat()});