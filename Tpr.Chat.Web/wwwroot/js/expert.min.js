var quickReplyIsVisible=!1,infoConnection,chatConnection;const updateInterval=1e3;const updateInfo=()=>infoConnection.invoke("MainUpdate",appealId),onReceiveInfo=(n,t,i,r)=>{if(r){infoConnection.stop();chatConnection.stop();$("#alarm").hide();return}if(i){const n="До окончания консультации осталось "+remainingText;$("#alarm").text(n).show()}setTimeout(updateInfo,updateInterval)},toggleQuickReply=n=>{quickReplyIsVisible=n,n?($("#quickReplyButton img").attr("src","images/chat/down-chevron.svg"),$("#quickReply").fadeIn("fast"),$("#quickReply .quick-reply").slideDown("fast",()=>$("#filterText").focus())):($("#quickReplyButton img").attr("src","images/chat/quick-reply.svg"),$("#quickReply").fadeOut("fast"),$("#quickReply .quick-reply").slideUp("fast",()=>$("#filterText").val("").trigger("input")))},chatError=n=>{console.error(n.toString()),$("#messageForm, #quickReply").remove()},changeStatus=n=>$("#onlineStatus").toggleClass("online",n),sendMessage=n=>{chatConnection.send("SendMessage",n),$("#messageText").val("").trigger("input")},onReceiveMessage=n=>{const i=n.nickName==="Член КК № "+expertKey,t=receiveMessage(n,i);$("#messagesList").append(t).scrollTo(t)},onJoinUser=(n,t)=>{changeStatus(t);const r=n.nickName==="Член КК № "+expertKey,i=joinMessage(n,r);$("#messagesList").append(i).scrollTo(i)},onLeaveUser=n=>{changeStatus(!1);const i=n.nickName==="Член КК № "+expertKey,t=leaveMessage(n,i);$("#messagesList").append(t).scrollTo(t)},onFirstExpert=n=>{const i=nickname!=="Апеллянт",t=firstExpertMessage(n,i);$("#messagesList").append(t).scrollTo(t)},onChangeExpert=n=>{$("#messageForm, #quickReply").remove();const t=changeExpertMessage(n);$("#messagesList").append(t).scrollTo(t)},onChatReady=()=>{$("#sendButton").on("click",()=>sendMessage($("#messageText").val()));$("#quickReplyButton").on("click",()=>toggleQuickReply(!quickReplyIsVisible));$("#replyList").on("click","li",function(){toggleQuickReply(!1);$("#messageText").insertAtCursor($(this).text()).focus().trigger("input")});$("#filterText").on("input",function(){var n=$(this).val();$("#replyList li").hide().filter(":icontains('"+n+"')").show().each((t,i)=>$(i).highlightText(n))});$("#messageText").on("keyup",function(n){n.keyCode!==13||n.shiftKey||(n.preventDefault(),$(this).val().length>0&&sendMessage($(this).val()))});$("#messageText").on("input",function(){$(this).expandRows();const n=$(this).val().length===0;$("#sendButton").prop("disabled",n)});$("#messageText").trigger("input")};infoConnection=(new signalR.HubConnectionBuilder).withUrl("/info").build();infoConnection.on("ReceiveInfo",onReceiveInfo);$(document).ready(onChatReady);infoConnection.start().then(updateInfo);getAccessToken(appealId,expertKey).then(n=>{chatConnection=(new signalR.HubConnectionBuilder).withUrl("/chat",{accessTokenFactory:()=>n}).build();chatConnection.on("Receive",onReceiveMessage);chatConnection.on("Join",onJoinUser);chatConnection.on("Leave",onLeaveUser);chatConnection.on("FirstJoinExpert",onFirstExpert);chatConnection.on("ChangeExpert",onChangeExpert);chatConnection.start()}).catch(chatError);