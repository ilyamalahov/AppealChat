$(document).ready(function(){getAccessToken().then(n=>{const e=1e4,i=(new signalR.HubConnectionBuilder).withUrl("/info").build();i.on("ReceiveInfo",(n,t,i,r)=>{var s,h;r&&location.reload();var o=luxon.Duration.fromMillis(t),u=o.toFormat("hh:mm:ss"),c=o.as("minutes");c<1&&(u="меньше");$("#remainingTime").text(u);s=luxon.DateTime.fromISO(n,{zone:"utc+3"});$(".moscow-value").text(s.toFormat("t"));i&&(h="До окончания консультации осталось "+u+" минут(-ы)",$("#alarm").text(h).show());setTimeout(f,e)});const t=(new signalR.HubConnectionBuilder).withUrl("/chat",{accessTokenFactory:()=>n}).build();t.on("Receive",n=>{const i=n.nickName==="Апеллянт",t=receiveMessage(n,i);$("#messagesList").append(t).scrollTo(t)});t.on("Join",(n,t,i)=>{u(i);const r=n.nickName==="Апеллянт";if(r){const f=joinMessage(n,r);$("#messagesList").append(f).scrollTo(f)}});t.on("Leave",(n,t)=>{u(t);const i=n.nickName==="Апеллянт";if(i){const r=leaveMessage(n,i);$("#messagesList").append(r).scrollTo(r)}});t.on("FirstJoinExpert",n=>{const i=n==="Апеллянт",t=firstJoinExpertMessage(n,i);$("#messagesList").append(t).scrollTo(t)});$("#sendButton").on("click",()=>r($("#messageText").val()));$("#messageText").on("input",function(n){const t=n.target,i=calculateExpandRows(t);t.rows+=i;const r=$(this).val().length>0;$("#sendButton").prop("disabled",!r)});$("#messageText").on("keyup",function(n){n.keyCode!==13||n.shiftKey||(n.preventDefault(),$(this).val().length>0&&r($(this).val()))});$("#emojiButton").on("click",()=>$("#emojiGrid").toggle());$("#switchExpertButton").on("click",()=>$("#modal").showModal("ajax/switchexpert"));$("#completeButton").on("click",()=>$("#modal").showModal("ajax/completechat"));const o=n=>{$("#changeOverlay").toggle(n),$("#changeSpinner").toggle(n),$("#switchExpertButton").prop("disabled",!n)},r=n=>{t.invoke("SendMessage",n).catch(n=>console.error(n.error)),$("#messageText").val("").trigger("input")},u=n=>{const t=n!==null,i=t?"№"+n:"отсутствует";$("#expertNumber").text(i);$("#onlineStatus").toggleClass("online",t)},f=()=>i.invoke("MainUpdate",appealId);$("#messageText").trigger("input");t.start().catch(n=>console.error(n.toString()));i.start().then(f).catch(n=>console.error(n.toString()))})});