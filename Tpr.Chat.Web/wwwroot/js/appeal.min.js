var infoConnection,chatConnection;const interval=1e4,onReceiveMessage=n=>{const i=n.nickName==="Апеллянт",t=receiveMessage(n,i);$("#messagesList").append(t).scrollTo(t)},onJoinUser=(n,t,i)=>{changeStatus(i!==null);const r=n.nickName==="Апеллянт";if(r){const u=joinMessage(n,r);$("#messagesList").append(u).scrollTo(u)}},onLeaveUser=n=>{changeStatus(!1);const t=n.nickName==="Апеллянт";if(t){const i=leaveMessage(n,t);$("#messagesList").append(i).scrollTo(i)}},onFirstExpert=n=>{waitChange(!1);const i="№"+n;$("#expertNumber").text(i);const r=nickname==="Апеллянт",t=firstExpertMessage(n,r);$("#messagesList").append(t).scrollTo(t)},onChangeExpert=n=>{const t=changeExpertMessage(n);$("#messagesList").append(t).scrollTo(t)},onReceiveInfo=(n,t,i,r)=>{var e,o;r&&location.reload();var f=luxon.Duration.fromMillis(t),u=f.toFormat("hh:mm:ss"),s=f.as("minutes");s<1&&(u="меньше");$("#remainingTime, #mobileRemainingTime").text(u);e=luxon.DateTime.fromISO(n,{zone:"utc+3"});$("#moscowTime").text(e.toFormat("t"));i&&(o="До окончания консультации осталось "+u+" минут(-ы)",$("#alarm").text(o).show());setTimeout(updateInfo,interval)},sendMessage=n=>{chatConnection.send("SendMessage",n),$("#messageText").val("").trigger("input")},changeStatus=n=>$("#onlineStatus").toggleClass("online",n),changeExpert=n=>{$.ajax({method:"POST",url:"ajax/expert/change",data:{appealId:n},beforeSend:()=>$("#changeButton").prop("disabled",!0),success:()=>waitChange(!0),error:n=>{alert(n.responseText),$("#changeButton").prop("disabled",!1)}})},waitChange=n=>{n?($("#messageForm").hide(),$("#modal").showModal("modal/waitchange")):($("#messageForm").show(),$("#modal").hideModal())},updateInfo=()=>infoConnection.send("MainUpdate",appealId);getAccessToken(appealId).then(n=>{infoConnection=(new signalR.HubConnectionBuilder).withUrl("/info").build();chatConnection=(new signalR.HubConnectionBuilder).withUrl("/chat",{accessTokenFactory:()=>n}).build();infoConnection.on("ReceiveInfo",onReceiveInfo);chatConnection.on("Receive",onReceiveMessage);chatConnection.on("Join",onJoinUser);chatConnection.on("Leave",onLeaveUser);chatConnection.on("FirstJoinExpert",onFirstExpert);chatConnection.on("ChangeExpert",onChangeExpert);chatConnection.start().catch(n=>console.error(n.toString()));infoConnection.start().then(updateInfo).catch(n=>console.error(n.toString()))});$(document).ready(()=>{$("#sendButton").on("click",()=>sendMessage($("#messageText").val()));$("#changeButton, #mobileSwitchButton").on("click",()=>changeExpert(appealId));$("#messageText").on("input",function(){$(this).expandRows();const n=$(this).val().length===0;$("#sendButton").prop("disabled",n)});$("#messageText").on("keyup",function(n){n.keyCode!==13||n.shiftKey||(n.preventDefault(),$(this).val().length>0&&sendMessage($(this).val()))});$("#messageText").trigger("input");waitChange(isWaiting)});