$(document).ready(function(){getAccessToken().then(n=>{const i=(new signalR.HubConnectionBuilder).withUrl("/info").configureLogging(signalR.LogLevel.Trace).build();i.start().then(()=>{i.invoke("MainUpdate",appealId)}).catch(console.log("Error connection"));i.on("ReceiveInfo",(n,t,i)=>{var u,f,r,e;console.log(n,t,i);u=luxon.DateTime.fromISO(n,{zone:"utc+3"});$("#moscowTime").text(u.toFormat("t"));f=luxon.Duration.fromMillis(t);r=f.toFormat("m");$("#remainingTime").text(r);i&&(e="До окончания консультации осталось "+r+" минут(-ы)",$("#alarm").text(e).show())});const t=(new signalR.HubConnectionBuilder).withUrl("/chat?token="+n).build();t.start();t.on("Receive",(n,t)=>{const i=receiveMessage(n,t==="appeal");$("#messagesList").append(i).scrollTo(i)});t.on("Join",(n,t,i,r)=>{const u=joinUser(n,t==="appeal",i,r);$("#messagesList").append(u).scrollTo(u);f(r)});t.on("Leave",(n,t)=>{const i=leaveUser(n,t==="appeal");$("#messagesList").append(i).scrollTo(i);f(!1)});$("#moscowTime").on("click",function(){i.invoke("MainUpdate")});$("#sendButton").on("click",()=>{u($("#messageText").val())});$("#messageText").on("input",function(n){var t=n.target,i=s(t);t.rows+=i;o($(this).val()==="")});$("#messageText").on("keyup",function(n){n.keyCode!==13||n.shiftKey||(n.preventDefault(),$(this).val()!==""&&u($(this).val()))});$("#emojiButton").on("click",()=>$("#emojiGrid").toggle());$("#switchExpertButton").on("click",()=>showModal("ajax/changeexpert"));$("#completeButton").on("click",()=>showModal("ajax/complete"));$("#completeOkButton").on("click",()=>{alert(),closeModal()});const r=n=>{$("#changeOverlay").toggle(n),$("#changeSpinner").toggle(n),$("#switchExpertButton").prop("disabled",!n)},c=(n,t)=>{var r=$('<div class="message '+(t?"place-left":"place-right")+'"><\/div>').html(n),i=$("<li><\/li>").html(r);$("#messagesList").append(i).scrollTo(i)},u=n=>{t.invoke("SendMessage",n).catch(n=>console.error(n)),$("#messageText").val("").trigger("input")},o=n=>{$("#sendButton").prop("disabled",n)},s=n=>{var i=n.dataset.minRows|1,t;return n.rows=i,t=Math.ceil((n.scrollHeight-n.clientHeight)/16),Math.max(0,Math.min(t,4))},h=t=>{var f=luxon.DateTime.fromMillis(t.moscowDate,{zone:"utc+3"}),r,i,u;$("#moscowTime").text(f.toFormat("t"));r=luxon.Duration.fromMillis(t.remainingTime);i=r.toFormat("m");$("#remainingTime").text(i);t.isAlarm&&(u="До окончания консультации осталось "+i+" минут(-ы)",$("#alarm").text(u).show());setTimeout(updateInfo,e,e,n,h)},f=n=>{const t=n?"В сети":"Не в сети";$("#onlineStatus").text(t)},e=1e4;$(this).on("click","#changeOkButton",()=>{changeExpert(n,()=>{closeModal(),r(!0)}).then(n=>{$("#expertNumber").val(n.expertKey),r(!1)}).catch(n=>{alert(n.error),r(!1)})})})});