$(document).ready(function(){getAccessToken().then(n=>{const t=(new signalR.HubConnectionBuilder).withUrl("/chat",{accessTokenFactory:()=>n}).build();t.start();t.on("Receive",(n,t)=>{const i=receiveMessage(n,t==="appeal");$("#messagesList").append(i).scrollTo(i)});t.on("Join",(n,t,i,r)=>{const u=joinUser(n,t==="appeal",i,r);$("#messagesList").append(u).scrollTo(u);f(r)});t.on("Leave",(n,t)=>{const i=leaveUser(n,t==="appeal");$("#messagesList").append(i).scrollTo(i);f(!1)});$("#moscowTime").on("click",function(){infoConnection.invoke("MainUpdate")});$("#sendButton").on("click",()=>e($("#messageText").val()));$("#messageText").on("input",function(n){const t=n.target,i=s(t);t.rows+=i;o($(this).val()==="")});$("#messageText").on("keyup",messageTextKeyup);$("#emojiButton").on("click",()=>$("#emojiGrid").toggle());$("#switchExpertButton").on("click",()=>showModal("ajax/changeexpert"));$("#completeButton").on("click",()=>showModal("ajax/complete"));$("#completeOkButton").on("click",()=>{alert(),closeModal()});const i=n=>{$("#changeOverlay").toggle(n),$("#changeSpinner").toggle(n),$("#switchExpertButton").prop("disabled",!n)},h=(n,t)=>{const r=$('<div class="message '+(t?"place-left":"place-right")+'"><\/div>').html(n),i=$("<li><\/li>").html(r);$("#messagesList").append(i).scrollTo(i)},e=n=>{t.invoke("SendMessage",n).catch(n=>console.error(n)),$("#messageText").val("").trigger("input")},o=n=>{$("#sendButton").prop("disabled",n)},s=n=>{const t=n.dataset.minRows|1;n.rows=t;const i=Math.ceil((n.scrollHeight-n.clientHeight)/16);return Math.max(0,Math.min(i,4))},u=n=>{var i=luxon.Duration.fromMillis(n.remainingTime),t,f,e;const o=i.as("milliseconds");o<=0&&(window.location="/"+appealId);t=i.as("minutes");t=t<=0?"меньше минуты":i.toFormat("m минут(-ы)");$("#remainingTime").text(t);f=luxon.DateTime.fromISO(n.moscowDate,{zone:"utc+3"});$("#moscowTime").text(f.toFormat("t"));n.isAlarm&&(e="До окончания консультации осталось "+t,$("#alarm").text(e).show());setTimeout(updateInfo,r,r,appealId,u)},f=n=>{const t=n?"В сети":"Не в сети";$("#onlineStatus").text(t)},r=1e4;updateInfo(r,appealId,u);$(this).on("click","#changeOkButton",()=>{changeExpert(n,()=>{closeModal(),i(!0)}).then(n=>{$("#expertNumber").val(n.expertKey),i(!1)}).catch(n=>{alert(n.error),i(!1)})})})});