var infoConnection=(new signalR.HubConnectionBuilder).withUrl("info").build(),chatConnection,accessToken;const tokenInterval=2e4,infoInterval=1e4,originalHeight=$(window).height(),onReceiveMessage=n=>{const i=n.nickName==="Апеллянт",t=receiveMessage(n,i);$("#messagesList").append(t).scrollTo(t)},onJoinUser=(n,t,i,r)=>{changeStatus(r);const u=t==="Апеллянт";if(u){const f=joinMessage(n,t,u);$("#messagesList").append(f).scrollTo(f)}},onLeaveUser=(n,t)=>{changeStatus(!1);const i=t==="Апеллянт";if(i){const r=leaveMessage(n,t,i);$("#messagesList").append(r).scrollTo(r)}},onFirstJoinExpert=n=>{const i="№"+n;$("#expertNumber").text(i);const t=firstJoinMessage(n,!1);$("#messagesList").append(t).scrollTo(t)},onInitializeChange=n=>{const t=changeExpertMessage(n);$("#messagesList").append(t).scrollTo(t)},onCompleteChange=()=>{refreshToken(appealId),waitChange(!1)},onReceiveInfo=(n,t,i,r)=>{var e,o;r&&location.reload();var f=luxon.Duration.fromMillis(t),u=f.toFormat("mm:ss"),s=f.as("minutes");s<1&&(u="меньше");$("#remainingTime, #mobileRemainingTime").text(u);e=luxon.DateTime.fromISO(n,{zone:"utc+3"});$("#moscowTime").text(e.toFormat("t"));i&&(o="До окончания консультации осталось "+u+" минут(-ы)",$("#alarm").text(o).show());setTimeout(updateInfo,infoInterval)},sendMessage=n=>{chatConnection.send("SendMessage",appealId,n),$("#messageText").val("").trigger("input")},scrollToLast=function(){const n=$(this).height();if(n!==originalHeight){const n=$("#messagesList").children(":last-child");$("#messagesList").scrollTo(n)}},changeStatus=n=>$("#onlineStatus").toggleClass("online",n),changeExpert=n=>{$.ajax({method:"POST",url:"ajax/change/expert",data:{appealId:n},beforeSend:()=>$("#changeButton, #changeMobileButton").prop("disabled",!0),success:()=>waitChange(!0),error:n=>{alert(n.responseText),$("#changeButton, #changeMobileButton").prop("disabled",!1)}})},completeChat=n=>{$.ajax({method:"POST",url:"ajax/chat/complete",data:{appealId:n},beforeSend:()=>$("#completeButton, #completeMobileButton").prop("disabled",!0),success:()=>location.reload(),error:n=>{alert(n.responseText),$("#completeButton, #completeMobileButton").prop("disabled",!1)}})},waitChange=n=>{n?($("#messageForm").hide(),$("#modal").showModal("modal/waitchange")):($("#messageForm").show(),$("#modal").hideModal())},updateInfo=()=>infoConnection.send("MainUpdate",appealId),refreshToken=n=>getJwtToken(n).then(t=>{accessToken=t,setTimeout(()=>refreshToken(n),tokenInterval)}),onMessageTextKeyup=function(n){n.keyCode!==13||n.shiftKey||(n.preventDefault(),$(this).val().length>0&&sendMessage($(this).val()))},onMessageTextInput=function(){$(this).expandRows();const n=$(this).val().length===0;$("#sendButton").prop("disabled",n)},connectToChat=()=>{chatConnection.send("Join",appealId),setTimeout(()=>refreshToken(appealId),tokenInterval)};infoConnection.on("ReceiveInfo",onReceiveInfo);$(window).on("resize",scrollToLast);$(document).ready(()=>{$("#sendButton").on("click",()=>sendMessage($("#messageText").val()));$("#sideMobileButton").on("click",()=>toggleSideMenu(!0));$("#changeButton, #mobileChangeButton").on("click",()=>$("#modal").showModal("modal/changeexpert"));$("#completeButton, #completeMobileButton").on("click",()=>$("#modal").showModal("modal/completechat"));$("#messageText").on("keyup",onMessageTextKeyup).on("input",onMessageTextInput).trigger("input");waitChange(isWaiting)});infoConnection.start().then(updateInfo);getJwtToken(appealId).then(n=>{accessToken=n;const t={accessTokenFactory:()=>accessToken};chatConnection=(new signalR.HubConnectionBuilder).withUrl("chat",t).configureLogging(signalR.LogLevel.Trace).build();chatConnection.on("Receive",onReceiveMessage);chatConnection.on("Join",onJoinUser);chatConnection.on("Leave",onLeaveUser);chatConnection.on("FirstJoinExpert",onFirstJoinExpert);chatConnection.on("InitializeChange",onInitializeChange);chatConnection.on("CompleteChange",onCompleteChange);return chatConnection.start()}).then(connectToChat).catch(n=>console.error(n.toString()));$(document).on("click","#okChangeButton, #okChangeMobileButton",()=>{$("#modal").hideModal(),changeExpert(appealId)});$(document).on("click","#okCompleteButton, #okCompleteMobileButton",()=>{$("#modal").hideModal(),completeChat(appealId)});