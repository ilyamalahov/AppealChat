$(document).ready(function(){getAccessToken().then(n=>{const e=1e4,i=(new signalR.HubConnectionBuilder).withUrl("/info").build();i.on("ReceiveInfo",(n,t,i,r)=>{var u,s,o,h,c;r&&location.reload();u=luxon.Duration.fromMillis(t);s=u.as("minutes");o=s<1?"меньше":u.toFormat("hh:mm:ss");$("#remainingTime").text(o);h=luxon.DateTime.fromISO(n,{zone:"utc+3"});$("#moscowTime").text(h.toFormat("t"));i&&(c="До окончания консультации осталось "+o+" минут(-ы)",$("#alarm").text(c).show());setTimeout(f,e)});const t=(new signalR.HubConnectionBuilder).withUrl("/chat",{accessTokenFactory:()=>n}).build();t.on("Receive",(n,t)=>{const i=receiveMessage(n,t==="appeal");$("#messagesList").append(i).scrollTo(i)});t.on("Join",(n,t,i,r)=>{if(t!="expert"){const f=joinMessage(n,t==="appeal");$("#messagesList").append(f).scrollTo(f);u(r)}});t.on("Leave",(n,t,i)=>{if(t!="expert"){const r=leaveMessage(n,t==="appeal");$("#messagesList").append(r).scrollTo(r);u(i)}});$("#sendButton").on("click",()=>r($("#messageText").val()));$("#messageText").on("input",function(n){const t=n.target,i=calculateExpandRows(t);t.rows+=i;const r=$(this).val().length>0;$("#sendButton").prop("disabled",!r)});$("#messageText").on("keyup",function(n){n.keyCode!==13||n.shiftKey||(n.preventDefault(),$(this).val().length>0&&r($(this).val()))});$("#emojiButton").on("click",()=>$("#emojiGrid").toggle());$("#switchExpertButton").on("click",()=>showModal("ajax/changeexpert"));$("#completeButton").on("click",()=>showModal("ajax/complete"));const o=n=>{$("#changeOverlay").toggle(n),$("#changeSpinner").toggle(n),$("#switchExpertButton").prop("disabled",!n)},r=n=>{t.invoke("SendMessage",n).catch(n=>console.error(n.error)),$("#messageText").val("").trigger("input")},u=n=>{const t=n!=null,i=t?"№"+n:"отсутствует";$("#expertNumber").text(i);$("#onlineStatus").toggleClass("online",t)},f=()=>i.invoke("MainUpdate",appealId);$("#messageText").trigger("input");t.start().catch(n=>console.error(n.toString()));i.start().then(f).catch(n=>console.error(n.toString()))})});