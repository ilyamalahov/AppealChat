var infoConnection,chatConnection;const interval=1e4,originalHeight=$(window).height(),onReceiveMessage=n=>{const i=n.nickName==="Апеллянт",t=receiveMessage(n,i);$("#messagesList").append(t).scrollTo(t)},onJoinUser=(n,t,i,r,u)=>{changeStatus(u);const f=t==="Апеллянт";if(i){const n="№"+expertKey;$("#expertNumber").text(n)}if(i||f){const e=joinMessage(n,t,i,f);$("#messagesList").append(e).scrollTo(e)}},onLeaveUser=n=>{changeStatus(!1);const t=n.nickName==="Апеллянт";if(t){const i=leaveMessage(n,t);$("#messagesList").append(i).scrollTo(i)}},onCompleteChange=()=>waitChange(!1),onInitalizeChange=n=>{const t=changeExpertMessage(n);$("#messagesList").append(t).scrollTo(t)},onReceiveInfo=(n,t,i,r)=>{var e,o;r&&location.reload();var f=luxon.Duration.fromMillis(t),u=f.toFormat("mm:ss"),s=f.as("minutes");s<1&&(u="меньше");$("#remainingTime, #mobileRemainingTime").text(u);e=luxon.DateTime.fromISO(n,{zone:"utc+3"});$("#moscowTime").text(e.toFormat("t"));i&&(o="До окончания консультации осталось "+u+" минут(-ы)",$("#alarm").text(o).show());setTimeout(updateInfo,interval)},sendMessage=n=>{chatConnection.send("SendMessage",n),$("#messageText").val("").trigger("input")},scrollToLast=function(){const n=$(this).height();if(n!==originalHeight){const n=$("#messagesList").children(":last-child");$("#messagesList").scrollTo(n)}},changeStatus=n=>$("#onlineStatus").toggleClass("online",n),changeExpert=n=>{$.ajax({method:"POST",url:"ajax/expert/change",data:{appealId:n},beforeSend:()=>$("#changeButton, #changeMobileButton").prop("disabled",!0),success:()=>waitChange(!0),error:n=>{alert(n.responseText),$("#changeButton, #changeMobileButton").prop("disabled",!1)}})},completeChat=n=>{$.ajax({method:"POST",url:"ajax/chat/complete",data:{appealId:n},beforeSend:()=>$("#completeButton, #completeMobileButton").prop("disabled",!0),success:()=>location.reload(),error:n=>{alert(n.responseText),$("#completeButton, #completeMobileButton").prop("disabled",!1)}})},waitChange=n=>{n?($("#messageForm").hide(),$("#modal").showModal("modal/waitchange"),chatConnection.stop(),infoConnection.stop()):($("#messageForm").show(),$("#modal").hideModal(),chatConnection.start().catch(n=>console.error(n.toString())),infoConnection.start().then(updateInfo).catch(n=>console.error(n.toString())))},updateInfo=()=>infoConnection.send("MainUpdate",appealId);getAccessToken(appealId).then(n=>{infoConnection=(new signalR.HubConnectionBuilder).withUrl("/info").build();chatConnection=(new signalR.HubConnectionBuilder).withUrl("/chat",{accessTokenFactory:()=>n}).build();infoConnection.on("ReceiveInfo",onReceiveInfo);chatConnection.on("Receive",onReceiveMessage);chatConnection.on("Join",onJoinUser);chatConnection.on("Leave",onLeaveUser);chatConnection.on("InitializeChange",onInitalizeChange);chatConnection.on("CompleteChange",onCompleteChange);chatConnection.start().catch(n=>console.error(n.toString()));infoConnection.start().then(updateInfo).catch(n=>console.error(n.toString()));waitChange(isWaiting)});$(document).ready(()=>{$(window).on("resize",scrollToLast);$("#sendButton").on("click",()=>sendMessage($("#messageText").val()));$("#sideMobileButton").on("click",()=>toggleSideMenu(!0));$("#changeButton, #mobileChangeButton").on("click",()=>$("#modal").showModal("modal/changeexpert"));$("#completeButton, #completeMobileButton").on("click",()=>$("#modal").showModal("modal/completechat"));$("#messageText").on("input",function(){$(this).expandRows();const n=$(this).val().length===0;$("#sendButton").prop("disabled",n)});$("#messageText").on("keyup",function(n){n.keyCode!==13||n.shiftKey||(n.preventDefault(),$(this).val().length>0&&sendMessage($(this).val()))});$("#messageText").trigger("input")});$(document).on("click","#okChangeButton, #okChangeMobileButton",()=>{$("#modal").hideModal(),changeExpert(appealId)});$(document).on("click","#okCompleteButton, #okCompleteMobileButton",()=>{$("#modal").hideModal(),completeChat(appealId)});