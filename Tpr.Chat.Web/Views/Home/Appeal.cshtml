@using Tpr.Chat.Core.Models
@model Tpr.Chat.Web.Models.IndexViewModel

@{
    ViewData["Title"] = "Home Page";
}

@section Styles {
    <link rel="stylesheet" type="text/css" href="~/css/main.css" />
}

@section Scripts {
    <script>
        var appealId = "@Model.ChatSession.AppealId";
        var expertKey = "@Model.ChatSession.CurrentExpert";
    </script>
    <script type="text/javascript" src="~/js/luxon.min.js"></script>
    <script type="text/javascript" src="~/lib/signalr/signalr.js"></script>
    <script type="text/javascript" src="~/js/appeal.js"></script>
}

<div class="container">
    <partial name="_Header" />

    <div class="content">
        <div class="main">
            <ul id="messagesList" class="message-history">
                @foreach (var message in Model.Messages)
                {
                    var messageDate = message.CreateDate.ToString("G");

                    var isCurrent = message.NickName == "Аппелянт";

                    var nickname = isCurrent ? "Вы" : message.NickName;

                    <li>
                        <div class="message @(isCurrent ? "place-left" : "place-right")">
                            @switch (message.ChatMessageTypeId)
                            {
                                case ChatMessageTypes.Joined:
                                    @nickname @(isCurrent ? " подключились" : " подключился") @:к консультации <b>(@messageDate) </b>
                                    break;
                                case ChatMessageTypes.Message:
                                    <div class="message-bubble">@Html.Raw(message.MessageString)</div>@nickname <b>(@messageDate)</b>
                                    break;
                                case ChatMessageTypes.Leave:
                                    @nickname @(isCurrent ? " покинули" : " покинул") @:консультацию <b>(@messageDate)</b>
                                    break;
                            }
                        </div>
                    </li>
                }
            </ul>
            <div class="remaining-time">До конца консультации осталось: <span id="remainingTime">00 минут</span></div>
            <div id="emojiGrid" class="emoji-grid" style="display:none;"></div>
            <div class="form-footer">
                <button id="emojiButton" class="form-button"><img alt="Emoji" src="~/images/OpenSmilesTab.png" /></button>
                <textarea id="messageText" class="message-text" data-min-rows="1" rows="1" autocomplete="off" placeholder="Введите сообщение..."></textarea>
                <button id="sendButton" class="form-button"><img alt="Send" src="~/images/send.png" /></button>
            </div>
        </div>
        <div class="sidebar">
            <div class="info">
                <div style="border-bottom: 1px solid #ccc;">
                    <div style="margin-bottom:15px; text-align: center; background:#fff; border: 2px solid #ff8d00; padding: 10px; overflow: hidden; border-radius: 5px;">
                        <div style="font-size: 14px; color: #757575">Вас консультирует</div>
                        <div style="font-size: 22px; font-weight: bold;">Член<br />конфликтной комиссии</div>
                        <div style="font-size: 28px; font-weight: bold;">№ <span id="expertNumber">@Model.ChatSession.CurrentExpert</span></div>
                        <div id="onlineStatus" style="text-align: right;">Онлайн-статус</div>
                    </div>
                    <button id="switchExpertButton" class="custom-button" style="margin-bottom: 15px;">Сменить собеседника</button>
                    <button id="completeButton" class="custom-button complete-button" style="margin-bottom: 15px;">Завершить консультацию</button>
                </div>
                <div style="border-bottom: 1px solid #ccc; font-size: 18px; padding: 10px 0;">
                    <ul>
                        <li style="margin: 5px 0;">
                            <div>Номер апелляции</div>
                            <div style="font-weight: bold;">@Model.ChatSession.AppealNumber</div>
                        </li>
                        <li style="margin: 5px 0;">
                            <div>Подано заявление</div>
                            <div style="font-weight: bold;">@Model.ChatSession.ApplicationDate.ToString("g")</div>
                        </li>
                        <li style="margin: 5px 0;">
                            <div>Зарегистрирована</div>
                            <div style="font-weight: bold;">@Model.ChatSession.RegistrationDate.ToString("g")</div>
                        </li>
                        <li style="margin: 5px 0;">
                            <div>Предмет</div>
                            <div style="font-weight: bold;">@Model.ChatSession.Subject</div>
                        </li>
                        <li style="margin: 5px 0;">
                            <div>Дата экзамена</div>
                            <div style="font-weight: bold;">@Model.ChatSession.ExamDate.ToShortDateString()</div>
                        </li>
                    </ul>
                </div>
                <div style="font-size: 18px; padding: 10px 0;">
                    <div><a href="#">Инструкция по работе с чатом</a></div>
                    <div>Справочная служба конфликтной комиссии г. Москвы</div>
                    <div>+7 (499) 653-94-50</div>
                    <div>kk77@mcko.ru</div>
                </div>
            </div>
            <div class="footer">Московское время: <span id="moscowTime">9:32</span></div>
            <partial name="_Footer" />
        </div>
    </div>
</div>

<div id="modal" style="display: none;" class="modal"></div>